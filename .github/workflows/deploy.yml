name: Deploy Backend

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Deploy to Droplet
      env:
        DEPLOY_SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
        DEPLOY_SERVER_HOST: ${{ secrets.DEPLOY_SERVER_HOST }}
        DEPLOY_SERVER_SECRET: ${{ secrets.DEPLOY_SERVER_SECRET }}

      run: |
        
        # SSH to the server and deploy
        sshpass -p "$DEPLOY_SERVER_SECRET" ssh -o StrictHostKeyChecking=no $DEPLOY_SERVER_USER@$DEPLOY_SERVER_HOST << EOF
          cd app/bottle-caps-backend/
          
          yes | docker system prune -a || true
          yes | docker stop $(docker ps -q) || true
          yes | docker rm $(docker ps -aq) || true
          yes | docker image prune -af || true
          yes | docker volume prune -f || true

          git pull

          docker build -t bottle-caps-backend-container:latest .

          docker run -d --name bottle-caps-backend-container -p 8080:8080 bottle-caps-backend-container:latest
        EOF
